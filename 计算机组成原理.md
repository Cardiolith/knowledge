# 深入浅出计算机组成原理

![img](https://static001.geekbang.org/resource/image/aa/73/aa5f644331319421eb7549d67d4f8773.jpeg)

## 冯诺依曼体系结构

也叫存储程序计算机，即可编程的，可存储的计算机。

[EDVAC]: https://en.wikipedia.org/wiki/First_Draft_of_a_Report_on_the_EDVAC

主要包含以下几个部分：

- 运算器或者叫做数据通路：包含算术逻辑单元（ALU）和处理器寄存器（Processor Register)的处理器单元。
- 控制器：包含指令寄存器（Instruction Register)和程序计数器（Program Counter）的控制器单元。算数逻辑单元和控制器单元共同组成了CPU。
- 存储器：用于存储数据和指令的内存，以及更大容量的外部存储。
- 输入和输出设备，以及对应得输入和输出机制。

![img](https://static001.geekbang.org/resource/image/fa/2b/fa8e0e3c96a70cc07b4f0490bfe66f2b.jpeg?wh=2372*1505)



## 计算机组成原理知识图谱

![img](https://static001.geekbang.org/resource/image/12/ff/12bc980053ea355a201e2b529048e2ff.jpg?wh=3832*2540)

[北大计算机组成课程]: https://www.coursera.org/learn/jisuanji-zucheng



## CPU性能？

计算机的计时单位：CPU时钟

> 程序的 CPU 执行时间 =CPU 时钟周期数×时钟周期时间

减少程序的CPU执行时间：缩短所需的CPU时钟周期数或者时钟周期时间。

时钟周期时间就是计算机的主频，2.8GHz的时钟周期时间就是1/2.8GHz。

CPU时钟周期数 = 指令数×每条指令的平均时钟周期数(CPI)

> 程序的 CPU 执行时间 = 指令数×CPI×Clock Cycle Time



CPU一般叫做**超大规模集成电路**（Very-Large-Scale Integration，VLSI），实际上是一个个晶体管组合而成的。

> 功耗 ~= 1/2 ×负载电容×电压的平方×开关频率×晶体管数量

### 并行优化，理解阿姆达尔定律

多核CPU，通过并行提高性能。

**阿姆达尔定律**（Amdahl’s Law）。这个定律说的就是，对于一个程序进行优化之后，处理器并行运算之后效率提升的情况。具体可以用这样一个公式来表示：

> 优化后的执行时间 = 受优化影响的执行时间 / 加速倍数 + 不受影响的执行时间



## 计算机指令

从硬件的角度来看，CPU 就是一个超大规模集成电路，通过电路实现了加法、乘法乃至各种各样的处理逻辑。

软件工程师的角度来讲，CPU 就是一个执行各种计算机指令（Instruction Code）的逻辑机器。

C语言程序在Linux上执行，需要把整个程序翻译成一个汇编语言，这个过程我们叫做编译。

针对汇编代码，再用汇编器翻译成机器码，由0和1表示。

```c
int main()
{
  int a = 1; 
  int b = 2;
  a = a + b;
}
```

```shell
$ gcc -g -c test.c
$ objdump -d -M intel -S test.o
```

```c
0000000000000000 <main>:
int main() {
   0:   55                      push   rbp
   1:   48 89 e5                mov    rbp,rsp

        int a=1;
   4:   c7 45 fc 01 00 00 00    mov    DWORD PTR [rbp-0x4],0x1
        int b=2;
   b:   c7 45 f8 02 00 00 00    mov    DWORD PTR [rbp-0x8],0x2
        a = a+b;
  12:   8b 45 f8                mov    eax,DWORD PTR [rbp-0x8]
  15:   01 45 fc                add    DWORD PTR [rbp-0x4],eax
}
  18:   5d                      pop    rbp
  19:   c3                      ret
```

##### 常见的指令分为五大类：

- 算术类指令：加减乘除。
- 数据传输类指令：给变量复制，读写数据等。
- 逻辑类指令：逻辑上的或与非等。
- 条件分支类指令：if/else等。
- 无条件跳转指令：调用函数就是发起了一个无条件跳转指令。



##### MIPS指令集：

![img](https://static001.geekbang.org/resource/image/b1/bf/b1ade5f8de67b172bf7b4ec9f63589bf.jpeg)

MIPS指令是一个32位的整数，高6位叫操作码，表示这条指令具体是怎样的指令，剩下的26位有三种格式，分别是R,I和J。

- R指令，一般用来做算术和逻辑操作，里面有读取和写入数据的寄存器的地址。如果是逻辑位移操作，还有位移操作的位移量，最后的功能码是在前面的功能码不够用的，扩展操作码表示对应的具体指令的。
- I指令，通常用于数据传输，条件分支，以及在运算的时候使用的并非变量还是常数的时候。这个时候没有了位移量和操作码，有也没有第三个寄存器，而是把这三个部分合并成了一个地址值或者一个常数。
- J指令就是一个跳转指令。高6位以外的26位就是跳转后的地址。

```
add $t0,$s2,$s1
```

![img](https://static001.geekbang.org/resource/image/8f/1d/8fced6ff11d3405cdf941f6742b5081d.jpeg)

![img](https://static001.geekbang.org/resource/image/1e/7c/1e5ecb8c92b01defee1c2af8c864887c.png?wh=781x511)



## CPU是如何执行指令的？

逻辑上，我们可以认为，CPU 其实就是由一堆寄存器组成的。而寄存器就是 CPU 内部，由多个触发器（Flip-Flop）或者锁存器（Latches）组成的简单电路。

触发器和锁存器，其实就是两种不同原理的数字电路组成的逻辑门。

N 个触发器或者锁存器，就可以组成一个 N 位（Bit）的寄存器，能够保存 N 位的数据。比方说，我们用的 64 位 Intel 服务器，寄存器就是 64 位的。

![img](https://static001.geekbang.org/resource/image/cd/6f/cdba5c17a04f0dd5ef05b70368b9a96f.jpg?wh=2404*1375)

一个CPU中包含了多种不同功能的寄存器。

- PC寄存器，也叫指令地址寄存器，存放下一条需要执行的计算机指令的内存地址。
- 指令寄存器，用来存放当前正在执行的指令。
- 条件码寄存器，用里面的一个个标记位，存放CPU进行算数或者逻辑运算的结果。

除了这些特殊的寄存器，CPU 里面还有更多用来存储数据和内存地址的寄存器。这样的寄存器通常一类里面不止一个。我们通常根据存放的数据内容来给它们取名字，比如**整数寄存器、浮点数寄存器、向量寄存器和地址寄存器**等等。有些寄存器既可以存放数据，又能存放地址，我们就叫它**通用寄存器**。

实际上，一个程序执行的时候，CPU 会根据 PC 寄存器里的地址，从内存里面把需要执行的指令读取到指令寄存器里面执行，然后根据指令长度自增，开始顺序读取下一条指令。可以看到，**一个程序的一条条指令，在内存里面是连续保存的，也会一条条顺序加载**。

